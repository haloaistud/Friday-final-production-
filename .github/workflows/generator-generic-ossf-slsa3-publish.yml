name: SLSA Provenance - Generic L3

on:
  workflow_dispatch:          # Lets you run manually from Actions tab
  push:                       # Optional: runs on every push (comment out if unwanted)
    branches: [ main ]
  release:
    types: [created]          # Attaches provenance to GitHub Releases

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      base64_subjects: ${{ steps.hash.outputs.base64_subjects }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # =============================================
      #   REPLACE THIS WITH YOUR REAL BUILD COMMANDS
      # =============================================
      - name: Build example artifacts
        run: |
          echo "This is artifact one" > artifact1.txt
          echo "This is artifact two" > artifact2.bin
          # Add mkdir, npm build, go build, cargo build, etc. here

      # =============================================
      #   Generate SLSA subjects (required format)
      # =============================================
      - name: Generate base64-encoded sha256 subjects
        id: hash
        run: |
          set -euo pipefail

          # Find all files you want to attest (adjust pattern!)
          files=$(find . -type f \( -name "artifact*.txt" -o -name "artifact*.bin" \) 2>/dev/null || true)

          if [ -z "$files" ]; then
            echo "Error: No artifacts found to attest" >&2
            exit 1
          fi

          # Format: sha256sum â†’ base64 whole line list
          subjects=$(sha256sum $files | base64 -w0)
          echo "base64_subjects=$subjects" >> "$GITHUB_OUTPUT"

          # Optional: show what we're attesting
          echo "Attesting these files:"
          echo "$files"

  attest:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      id-token: write       # Required to sign with Sigstore / GitHub OIDC
      contents: write       # Required to upload to release (if upload-assets: true)

    
      
       base64-subjects: ${{ needs.build.outputs.base64_subjects }}
      upload-assets: true   # Attaches provenance.intoto.jsonl to release (if triggered by release)
